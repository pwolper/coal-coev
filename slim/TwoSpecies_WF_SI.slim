// Keywords: multispecies, interaction

species all initialize() {
	initializeSLiMModelType("nonWF");
	
	defineConstant("N", 20); //constant host population size
	defineConstant("c", 1); //contact rate, with which infected host will infect another host
	defineConstant("s_I", 0.1); //cost of infection to reproduction in hosts
	defineConstant("gamma", 0.005); //recovery rate of an infected individual

}

species pathogen initialize() {
	initializeSpecies(avatar="ðŸ¦ ", color="red");
	//initializeSLiMOptions(keepPedigrees=T); are pdeigreeID of two species unique?

}

species host initialize() {
	initializeSpecies(avatar="ðŸŒ¾", color="green");
	initializeSLiMOptions(keepPedigrees=T);
	
	initializeMutationType("m1", 0.5, "f", 0.0); //resistance mutation with no fitness cost yet
	m1.color = "cornflowerblue";
	initializeGenomicElementType("g1", m1, 1.0);
	initializeGenomicElement(g1, 0, 0);
	initializeMutationRate(0);
	initializeRecombinationRate(0);

}


species pathogen reproduction() {
	catn("\n - Pathogen reproduction/infection - ");
	catn("Host.tag: "); catn(p1.individuals.tag);
	catn("Host.pedigreeIDs: "); catn(p1.individuals.pedigreeID);
	catn("Infection Status: "); catn(p1.individuals.tagL0);
	//catn("HostIDs:"); catn(p1.individuals.pedigreeID);
	
	infectedHosts = p1.individuals[p1.individuals.tagL0 == T];
	cat("InfectedHosts: "); catn(infectedHosts);
	
	pathogens = p2.individuals;
	//cat("Pathogens: "); catn(pathogens);
	pathogenHosts = p2.individuals.tag;
	cat("pathogenHosts (pathogen.tag): "); catn(pathogenHosts);
	//cat("unique(pathogenHosts): "); catn(unique(pathogenHosts));
	
	
	// add vertical transmission from previous generation of hosts using pedigree parent ids...
	
	catn("\n ** Vertical transmissions **");
	
	//catn("Infection Status: "); catn(p1.individuals.tagL0);
	//catn("Host.pedigreeParentIDs"); catn(p1.individuals.pedigreeParentIDs); 
	
	for (infected in infectedHosts) {
		cat("	Host.pedgreeID: " + infected.pedigreeID + " "); cat("(" + infected.tagL0 + ") "); cat("Parents: "); 		catn(infected.pedigreeParentIDs);
		parents = infected.pedigreeParentIDs;
		//cat("	Parent: "); catn(parents[1]);
		pathogenInd = p2.individuals[p2.individuals.tag == infected.pedigreeID];
		cat("	PathogenInd: "); catn(pathogenInd.tag);
		
		if (parents[1] >= 0) {
			cat("	PathogenInd: "); cat(pathogenInd.tag); cat(" vertically transmitted to Host "); catn(infected.pedigreeID);
			pathogenInd.tag = infected.pedigreeID; 
		}
	
	}
	
	catn("\n ** Horizontal transmissions **");
	
	for (i in seqLen(p2.individualCount)) {
		source = p1.individuals[p1.individuals.pedigreeID == pathogens[i].tag];
		cat("	Source.tag: "); catn(source.tag);
		
		target = p1.sampleIndividuals(1);
		cat("	Target.tag: "); catn(target.tag);
		cat("	Target Infection Status: "); catn(target.tagL0);
		//target.tagL0 = T;
		
		//Reproduce pathogen if target.tagL0 == F (healthy)
		if (target.tagL0 == F) {
			catn("	* Infection from: " + source.tag + " -> " + target.tag);
			offspring = subpop.addCloned(pathogens[i]);
			offspring.tag = target.pedigreeID; offspring.color='red';
			target.tagL0 = T;
		}
	
	
	}
	//infected = p1.individuals[match(p1.individuals.pedigreeID, p2.individuals.tag) >= 0];
	//infected = p1.individuals[p1.individuals.tag == 1]; //will work when I add horizontal transmission.
	//cat("Infected: "); catn(infected);
	//catn("Number of infected individuals: " + length(infected));
	//catn(infected.pedigreeID);
	
	self.active = 0;
}



species host reproduction() {
	catn("\n - Host reproduction - ");
	catn("Hosts: "); catn(p1.individuals.tag);
	catn("Infections: "); catn(p1.individuals.tagL0);
	pathogenHosts = p2.individuals.tag;
	cat("pathogenHosts: "); catn(pathogenHosts);
	
	//fitness = p1.cachedFitness(NULL);
	//catn(fitness);
	
	parents = p1.sampleIndividuals(N, replace=T);
	catn("ParentIDs: "); catn(parents.tag);
	
	for (i in seqLen(N)) {
		offspring = subpop.addCloned(parents[i]);
		//offspring.tagL0 = F; //new offspring is not infected (no vertical transmission).
		offspring.color = parents[i].color;
		offspring.tag = parents[i].tag;
		offspring.tagL0 = parents[i].tagL0;
	}
	
	
	self.active = 0;
}





ticks all 1 early() {
	
	host.addSubpop("p1", N, haploid=T);
	p1.individuals.tagL0 = F; //Infection status. F for healthy, T for infected
	p1.individuals.color = colors(p1.individualCount, "turbo");
	p1.individuals.tag = seqLen(p1.individualCount);
	catn("Hosts: "); catn(p1.individuals.tag);
	
	//initial infection
	pathogen.addSubpop("p2", 1);
	p2.individuals.color = "red";
	//newHost = p1.sampleIndividuals(1, exclude=resistant); //choose host to be infected
	newHost = p1.sampleIndividuals(1);
	newHost.tagL0 = T; //newHost.color = "red";
	catn("Initial infection in host " + newHost.pedigreeID);
	p2.individuals.tag = newHost.pedigreeID; //tag pathogen with host.pedigreeID

}

ticks all 2: first() {
	catn("\n\n\n -- first() --");
	catn("Hosts: "); catn(p1.individuals.tag);
	catn("Infections: "); catn(p1.individuals.tagL0);
	//cat("HostIDs:"); catn(p1.individuals.pedigreeID);
	//catn("PathogenIDs:"); catn(p2.individuals.pedigreeID);
}

ticks all 1: early() {
	catn("\n-- early() --");
	//catn("HostIDs:"); catn(p1.individuals.pedigreeID);
	catn("Hosts: "); catn(p1.individuals.tag);
	//cat("Host Age: "); catn(p1.individuals.age);
	// 	catn("	fitnessScaling of Healthy");
	
	// 	healthy = p1.individuals[p1.individuals.tag == 0];
	// 	healthy.fitnessScaling = 1 + s_I;
	// 	catn(healthy.fitnessScaling);

}


species host survival() {
	//survival is independent of fitness; parents die, offspring live
	return (individual.age == 0);
}


ticks all 1: late() {
	catn("\n-- late() --");
	//catn("HostIDs:"); catn(p1.individuals.pedigreeID);
	catn("Hosts.tag: "); catn(p1.individuals.tag);
	catn("Host.pedigreeIDs: "); catn(p1.individuals.pedigreeID);
	catn("Infections: "); catn(p1.individuals.tagL0);
	pathogenHosts = p2.individuals.tag;
	cat("pathogenHosts (pathogen.tag): "); catn(pathogenHosts);
	//cat("Host Age: "); catn(p1.individuals.age);
	//infected = p1.individuals[p1.individuals.tag == 1];
	
	//susceptibles = p1.individuals[p1.individuals.tag == 0];
	//catn("\nN. susceptibles: " + length(susceptibles));
	//infected = p1.individuals[p1.individuals.tag == 1];
	//catn("N. infected: " + length(infected));
	
	//if (length(infected) == 0) {
	//	catn("Pathogen extinct!");
	//	community.simulationFinished();}

}

//species host survival() {}
//species parasitoid survival() {}

ticks all 3*N late() {}
